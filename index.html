<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>Generate an isochrone with Google Map API</title>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?&sensor=false"></script>
<script src="jquery.js" type="text/javascript"></script>

<script type="text/javascript">
    // Originally from: http://sandropaganotti.com/generate-an-isochrone-map-using-google-maps-api/
	// Rewritten for Google Maps API v3 - Ilia Karmanov 
	// Stable Version, optimised for 15minute drive times
	
	var default_int = 15/3000;
	// Sensitivity (increment)
    var inc_x = default_int;
    var inc_y = default_int;
	// Initial jump
	var x     = default_int;
    var y     = default_int;
	// Number of points
	var num_points = 20;
	// Stuck
	var stuck = 0;
	var stuck_old = 0;
	// Initialize around City, London
	var my_lat = 51.518175;
	var my_lng = -0.129064;
	var map = null;
    var geocoder = null;
	var directionsDisplay = new google.maps.DirectionsRenderer();
	var directionsService = new google.maps.DirectionsService();
	var polygon = new google.maps.Polygon;
    var m     = 0;
    var intval = null;
    var slice  = (2*Math.PI)/num_points; 
    var start_s = 0;
	var points    = new Array();
    var found     = 0;
	// Save previous results
	var prev_dest_lat = 0;
	var prev_dest_lng = 0;
	var old_dist = 0;
	var old_time = 0;
	var no_route = 0;
	
    function initialize() {	
		var mapOptions = {
			center: new google.maps.LatLng(my_lat, my_lng),
			zoom: 13
		};
		map = new google.maps.Map(document.getElementById('map-canvas'),
		mapOptions);
    }

	function drawisochrone(address,minutes){	
		// Initialise geocoder and directions
		geocoder = new google.maps.Geocoder();	
		directionsDisplay.setMap(map);	
		geocoder.geocode( { 'address': address}, function(point, status) {
		
		if (status == google.maps.GeocoderStatus.OK) {
			var source_lat = point[0].geometry.location.lat()
			var source_lng =point[0].geometry.location.lng()
			map.setCenter(point[0].geometry.location);
			//$('#loader').show();
			intval = setInterval( "crawldirections(" + source_lat + "," + 
			source_lng + "," + minutes +")", 1000);
		} else {
			alert("Geocode was not successful for the following reason: " + status);
		}
	});
					
	}
	
    function crawldirections(px,py,mins){
        var point      = new google.maps.Point(px,py);
        var destpoint  = new google.maps.Point(px + x,py + y);  
		var start = new google.maps.LatLng(point.x,point.y);
		var end = new google.maps.LatLng(destpoint.x,destpoint.y);
			
		// After initial push; follow directions service rather than ray 
		if (m > 3) {
		end = new google.maps.LatLng(prev_dest_lat + (inc_x * Math.sin(start_s)),
			prev_dest_lng + (inc_y * Math.cos(start_s)));
		console.log("Switching to direction route: " + prev_dest_lat + (inc_x * Math.sin(start_s)) + ", " +
			prev_dest_lng + (inc_y * Math.cos(start_s)))
		}
		
		if (stuck > stuck_old) {
		// Push out if stuck
		end = new google.maps.LatLng(prev_dest_lat + ((default_int*2) * Math.sin(start_s)),
			prev_dest_lng + ((default_int*2) * Math.cos(start_s)));
		}
		
		var request = {
			origin: start,
			destination: end,
			travelMode: google.maps.TravelMode.DRIVING
		};
		
        x = x + (inc_x * Math.sin(start_s));
        y = y + (inc_y * Math.cos(start_s));
        m = m + 1;
		
		directionsService.route(request,function(response, status) {
		if (status == google.maps.DirectionsStatus.OK) {
			console.log("Route OK. Try: " + m)
			no_route = 0
            //document.getElementById('txt1').value = 'y' + document.getElementById('txt1').value 
			
			// Display directions on screen
			directionsDisplay.setOptions({ preserveViewport: true })
			directionsDisplay.setDirections(response)
			
			var curr_meas = (response.routes[0].legs[0].duration.value/60).toFixed(2)
			var curr_dist = (response.routes[0].legs[0].distance.value/1000/1.609344).toFixed(2)
			var end_dir_lat = response.routes[0].legs[0].end_location.lat()
			var end_dir_lng = response.routes[0].legs[0].end_location.lng()
			console.log("Current min: " + curr_meas + ", prev min: " + old_time + ", target: " + mins)	
			
			// If now over target and before, under target then
			if (old_dist <= mins && curr_meas > mins){
                found     = 1;
            }else{
				// Dynamically adjust speed
				if (curr_meas < (0.75*mins)) {
					inc_x = (default_int*2);
					inc_y = (default_int*2);
				} else {
					inc_x = default_int;
					inc_y = default_int;
				}
				// Set current end coordinates as previous
				// If stuck, push forward:
				if (curr_meas == old_time && curr_dist == old_dist) {	
				console.log("Stuck, pushing forward")
				stuck_old = stuck
				stuck = stuck + 1
				}
				// Set current end coordinates as previous
				prev_dest_lat = end_dir_lat
				prev_dest_lng = end_dir_lng
				// Set current distance and time as previous
				old_dist = curr_dist
				old_time = curr_meas
            }
			// Max tries depends on minutes (will be longer with longer routes)
			if(curr_meas > (mins + (mins * 0.4)) || (found ==1) || (stuck > 2)){
			
				// Push previous directions coordinates to polygon array
                points.push(new google.maps.LatLng(prev_dest_lat,prev_dest_lng));
				// Place marker
				console.log("Found! " + curr_meas + ". Placing marker")
				var marker = new google.maps.Marker({
				// Use previous directions service coordinates (not geocoded)
				position: new google.maps.LatLng(prev_dest_lat,prev_dest_lng),
				map: map,
				// Small icon
				icon: 'https://maps.gstatic.com/intl/en_us/mapfiles/markers2/measle_blue.png',
				// Use previous distance and time
				title: 'Minutes: ' + old_time + 
				' Miles: ' + old_dist
				});
				
				polygon.setMap(null);
				polygon = new google.maps.Polygon({
                      paths: points,
                      strokeColor: '#0040FF',
                      fillColor: '#00BFFF',
                      fillOpacity: 0.2
					  //editable: true
				});
				polygon.setMap(map);
				
				// Next slice
                start_s = start_s + slice;
				// Reset variables		
				inc_x = default_int;
				inc_y = default_int;
				stuck_old = 0;
				stuck = 0;
                x = inc_x;
                y = inc_y;
                m = 0;
                found = 0;
                curr_meas = 0;
				old_dist = 0;
				old_time = 0;
				prev_dest_lng = 0;
				prev_dest_lat = 0;
				end_dir_lat = 0;
				end_dir_lng = 0;
				console.log("Done!")
            }                 
        }else{
			console.log("Google lock-out, try: " + m)
			//Retry
			prev_dest_lat = prev_dest_lat; /*+ (inc_x * Math.cos(start_s))*/
			prev_dest_lng = prev_dest_lng; /*+ (inc_y * Math.cos(start_s))*/
            //document.getElementById('txt1').value = 'n' + document.getElementById('txt1').value
			no_route = no_route + 1;
			
			if (no_route > 3) {
				console.log("No route. Skipping.")
				// Next slice
				start_s = start_s + slice;
				// Reset variables	
				inc_x = default_int;
				inc_y = default_int;
				stuck_old = 0;
				stuck = 0;
				x = inc_x;
				y = inc_y;
				m = 0;
				found = 0;
				curr_meas = 0;
				old_dist = 0;
				old_time = 0;
				prev_dest_lng = 0;
				prev_dest_lat = 0;
				end_dir_lat = 0;
				end_dir_lng = 0;
			}
		}
			// Finished all slices
            if(start_s >= (2*Math.PI)){
					console.log("End. Creating Polygon.")
                    start_s = 0;

					// Set a start marker:
					console.log("Setting start marker")
					var start_marker = new google.maps.Marker({
					// Use point that directions service was using for accuracy
					position: new google.maps.LatLng(response.routes[0].legs[0].start_location.lat(),
						response.routes[0].legs[0].start_location.lng()),
					map: map,
					icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
					title: 'Start'
				});	
					// Clear directions
					directionsDisplay.setMap();
                    //$('#loader').hide();
                    clearInterval(intval);
                }
		});
    }
	
</script>
</head>
<body style="margin:0px; padding:0px; background: #DDDDDD;" onload="initialize()">
  <center>
      <div style="padding-top: 4px; padding-bottom: 4px;">
          <label for="geolocation"/>Location:   </label>
          <input type="text" id="geolocation" name="geolocation" size="60" value="Hyde Park, London"/>
          <label for="minutes">     Minutes:    </label>
          <input type="text" id="minutes" name="minutes" size="3" maxlength="2" value="15"/>
          <input type="submit" value="Generate Isochrone"
                 onclick="this.value='Generating';drawisochrone(document.getElementById('geolocation').value,document.getElementById('minutes').value)"/>
          <!-- <img id="loader" src="loader.gif" style="display:none;"/> -->
     </div>
     <div id="map-canvas" style="width:70%; height:800px; border: 3px solid rgb(51, 51, 51);"></div>
     <div style="padding-top: 10px;">
         Specify a location and a driving time in minutes. <br> For any questions contact <a href="mailto:ikarmanov@crai.com">ikarmanov@crai.com</a>
     </div>
  </center>
  <textarea id="txt1" style="display:none;"></textarea>
  <div id="map-text" style="width:30%; height:800px; float: left; display:none;"></div>
</body>
</html>